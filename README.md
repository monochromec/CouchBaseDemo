A simple CouchDB demo.

This tiny demo illustrates the use of a Couchbase (CB) server, the Sync Gateway (SG) and an Android app to retrieve values from a bucket. Conceptually the code consists of a Python-based web app using Flask to offer a number of images on a web page. Clicking one of the images commits its name and bitmap to a predefined CB bucket.  Using CB's  SG, the Android app pulls the name and the initial bitmap from the bucket upon startup and watches through a ChangeDelegate (a CouchbaseLite (CBL) object) for any changes. Should the bucket content change, the image and name on the Android screen is automatically updated.

I created this sample code to provide a shorter learning curve than the examples on the CB website which in my opinion require too much background knowledge for the absolute beginner who's just starting with the overall architecture and surrounding software ecosystem of this popular NoSQL database.

Caveat: This code comes as it is. No effort has been made to finish and polish this code base for production deployment (for example, error checking and logging is virtually non-existent). Also commenting could be vastly improved. Proceed at your own risk :-) and enjoy learning and playing with it.

Prerequisites for running this demo which worked for me:

1. Install CB as a Docker container as described on the Couchbase Sync Gateway website (https://hub.docker.com/r/couchbase/sync-gateway). Be sure to create a bridged network before you run this container as described on the website if you intend to run both the CB server and SG instance on the same machine in different containers.
2. Create a cluster called "default" when setting up the server instance for the first time as described on the CB quick start page (https://developer.couchbase.com/documentation/server/current/install/getting-started-docker.html), leaving the default settings for the cluster as suggested (depending on your available server memory).
3. In this newly set up instance, create a default bucket called "default" and a user named "couchbase" and password "couchbase" with full admin rights. If you want to choose a different password (obviously for security reasons), do not forget to reflect this change in the SG configuration file used in the next step and when setting up the Flask app in step 5 below.
4. Set up the SG instance as described at https://hub.docker.com/r/couchbase/sync-gateway, using the network bridge you created in step 1 if deployed in different containers on the same machine. Also ensure that you map the admin port of the SG instance of the container it's running in (trust me, this will come in handy when debugging the SG instance later on). So the Docker statement for the creation of the container now should look similar to something like this depending on the volume mapping location of your configuration file:

````docker run --name cbsg --net=couchbase -p 4984-4985:4984-4985 -v /opt:/tmp/config -d couchbase/sync-gateway -adminInterface :4985 /tmp/config/my_sg_conf.json````

(/opt on the host in my case). Don't forget to include the "adminInterface" port specification; otherwise your port will only be visible to the localhost *inside* the container. The config directory of the repo contains a file called "my_sg_conf.json" which contains a minimal configuration for the SG instance. I purposely omitted any fancy Javascript sync function as part of the SG configuration (cf. https://developer.couchbase.com/documentation/mobile/current/guides/sync-gateway/sync-function-api-guide/index.html) in order to keep it simple; the more comprehensive ToDo example (https://github.com/couchbaselabs/ToDoLite-Android) contains a more elaborate SG configuration including a sync function that can serve as a starting point for further exploration.
5. Using PIP, install the Flask framework and the Python Couchbase library in either a virtualenv or on bare metal (ie. the operating system) on your server. I tested the server side Python with Python 3 only but I don't see why it shouldn't run on Python 2 also.
6. Install the Python Flask server code at a location of your choice and populate the "static" subdirectory with sample images, As the sample app represents a fashion blog (where a blogger can choose a picture which is then stored in the CB bucket and synchronized to the Android app running on the mobile), I chose images comparable to Ugly Dolls :-) but it goes without saying that these images are *not* part of the repo due to copyright reasons. Any images roughly square which can be rendered nicely on a web page will do (I chose approximately 500x500 px sizes). The current code base only recognizes ".png" files; this can easily be extended by expanding the "exts" list the function "getImages" in the server app called "app.py". Also reflect any password changes in the storeImageinCB function of the server code. Depending on your particular Flask deployment method, either modify the app.run invocation or use "````flask --host=0.0.0.0 ...````" if you want to go beyond localhost for connection acceptance.
7. Once you run the Flask app, you should be greeted with a nice webpage on port 5000 (Flask default configuration) offering the images you copied into the "static" folder. Clicking on an image will store the bitmap from the image file alonside the filename minus its extension in the bucket. You can check this by logging into the CB web UI and listing the documents of the "default" bucket.
8. If the SG is configured correctly, the synced document should now be available on SG server instance on port 4985 with the URL suffix ````_admin/db/db/documents/fashionPic```` ("````fashionPic````" being the document ID).
9. Using your Android / Java IDE of choice from IntelliJ :-) (I used AndroidStudio), open the project in the main repo folder. Verify in the IDE in the project configuration that both couchbase-lite-android and org.apache.commons.io are listed as library dependencies (otherwise your Android project won't build).
10. Modify the SG IP address in the member function "setupDB" to reflect your SG server instance. The database name "db" is reflected in the SG configuration JSON file - if you change this, please ensure that you change it both in the Java code as well as JSON config file (and don't forget to restart the SG Docker container :-).


Some hints:

- As the CB server logs as obtained by Docker are somewhat brief, it's worth checking out the logs inside the container. You will find them at ````/opt/couchbase/var/lib/couchbase/logs```` if you are using the standard CB image found on the Docker hub.
- Without a channel property a document will ***not*** be synchronized between the server and the gateway. This is why I included a "default" channel property in the document when creating it on the server side.
- The SG logs in contrast are quite comprehensive. ````docker logs <container name\>```` will do the trick.
- And - as usual - logcat or similar mechanisms (IDE-based or not) on the Android side provide you with a view from the client side.

If you want to help out by making the core more robust (error handling, comments, etc. come to mind :-) ), feel free to send me PRs with your improvements! More than happy to incorporate them if they check out.

I hope this code serves you as a starting point to explore the opportunities of synchronization between CB instances - have fun exploring it as much as I had writing the code!
